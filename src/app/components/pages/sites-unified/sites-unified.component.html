<div class="sites-page-container">
  <!-- Left Side: Sources Hierarchy Tree View -->
  <div class="site-tree-panel">
    <div class="tree-header">
      <mat-icon>account_tree</mat-icon>
      <span>Sources</span>
      <div class="tree-header-actions">
        <button mat-icon-button matTooltip="Select All" (click)="selectAll()">
          <mat-icon>done_all</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Clear Selection" (click)="clearSelections()">
          <mat-icon>clear</mat-icon>
        </button>
      </div>
    </div>
    <div class="tree-content">
      <!-- Country Level -->
      <div *ngFor="let country of sources" class="tree-level country-level">
        <div class="tree-node" (click)="toggleCountry(country)">
          <mat-icon class="expand-icon">{{ country.expanded ? 'expand_more' : 'chevron_right' }}</mat-icon>
          <mat-checkbox
            [checked]="country.selected"
            [indeterminate]="country.indeterminate"
            (click)="$event.stopPropagation()"
            (change)="toggleCountrySelection(country, $event)"
            class="tree-checkbox">
          </mat-checkbox>
          <span class="node-label country-label">{{ country.name }}</span>
        </div>

        <!-- Site Level -->
        <div *ngIf="country.expanded" class="tree-children">
          <div *ngFor="let site of country.sites" class="tree-level site-level">
            <div class="tree-node" (click)="toggleSite(site)">
              <mat-icon class="expand-icon">{{ site.expanded ? 'expand_more' : 'chevron_right' }}</mat-icon>
              <mat-checkbox
                [checked]="site.selected"
                [indeterminate]="site.indeterminate"
                (click)="$event.stopPropagation()"
                (change)="toggleSiteSelection(site, $event)"
                class="tree-checkbox">
              </mat-checkbox>
              <span class="node-label site-label">{{ site.name }}</span>
            </div>

            <!-- Location Level -->
            <div *ngIf="site.expanded" class="tree-children">
              <div *ngFor="let location of site.locations" class="tree-level location-level">
                <div class="tree-node location-node">
                  <div class="tree-indent"></div>
                  <mat-checkbox
                    [checked]="location.selected"
                    (change)="toggleLocation(location)"
                    class="tree-checkbox">
                  </mat-checkbox>
                  <span class="node-label location-label">{{ location.address }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Side: Main Content -->
  <div class="main-content">
    <!-- Sync Status Indicator -->
    <app-sync-status-indicator
      *ngIf="syncInfo"
      [syncInfo]="syncInfo"
      [dataSourceName]="'Sites'"
      [showRecordCount]="true"
      [showRefreshButton]="true"
      (refresh)="refreshSites()">
    </app-sync-status-indicator>

    <!-- Multi-Row Filter System -->
    <div class="complex-filters">
      <!-- Filter Row 1: Site Type -->
      <div class="filter-row">
        <span class="filter-label">Filter by Site type:</span>
        <div class="filter-pills">
          <button mat-button class="filter-pill"
                  [class.active]="siteTypeFilter === null"
                  (click)="onSiteTypeFilterChange(null)">
            <mat-icon *ngIf="siteTypeFilter === null">check</mat-icon>
            All
          </button>
          <button mat-button class="filter-pill"
                  [class.active]="siteTypeFilter === 'SD-WAN'"
                  (click)="onSiteTypeFilterChange('SD-WAN')">
            <mat-icon *ngIf="siteTypeFilter === 'SD-WAN'">check</mat-icon>
            <span appHelpTooltip="sd-wan">SD-WAN</span> Sites
          </button>
        </div>
      </div>

      <!-- Filter Row 2: Site Health -->
      <div class="filter-row">
        <span class="filter-label">Filter by Site Health:</span>
        <div class="filter-pills">
          <button mat-button class="filter-pill"
                  [class.active]="siteHealthFilter === null"
                  (click)="onSiteHealthFilterChange(null)">
            <mat-icon *ngIf="siteHealthFilter === null">check</mat-icon>
            All
          </button>
          <button mat-button class="filter-pill"
                  [class.active]="siteHealthFilter === 'Partially Inactive'"
                  (click)="onSiteHealthFilterChange('Partially Inactive')">
            <mat-icon *ngIf="siteHealthFilter === 'Partially Inactive'">check</mat-icon>
            Partially Inactive
          </button>
          <button mat-button class="filter-pill"
                  [class.active]="siteHealthFilter === 'Down'"
                  (click)="onSiteHealthFilterChange('Down')">
            <mat-icon *ngIf="siteHealthFilter === 'Down'">check</mat-icon>
            Down
          </button>
          <button mat-button class="filter-pill"
                  [class.active]="siteHealthFilter === 'No Info'"
                  (click)="onSiteHealthFilterChange('No Info')">
            <mat-icon *ngIf="siteHealthFilter === 'No Info'">check</mat-icon>
            No Info
          </button>
        </div>
      </div>

      <!-- Global Filter Search -->
      <div class="global-filter">
        <mat-form-field appearance="outline" class="filter-search">
          <mat-label>Filter</mat-label>
          <input matInput [(ngModel)]="globalFilter" (ngModelChange)="onGlobalFilterChange($event)">
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>
        <button
          mat-icon-button
          (click)="toggleHelpPanel()"
          matTooltip="Page help"
          class="help-button">
          <mat-icon>help_outline</mat-icon>
        </button>
        <button
          mat-icon-button
          color="primary"
          class="download-button"
          (click)="exportToCsv()"
          matTooltip="Export CSV"
          aria-label="Export CSV">
          <mat-icon>download</mat-icon>
        </button>
      </div>
    </div>

    <!-- Base Table -->
    <app-base-table
      [config]="tableConfig"
      [data]="filteredSites"
      [loading]="loading"
      [externalFiltersActive]="activeExternalFilters"
    ></app-base-table>
  </div>
</div>

<!-- Page Help Panel -->
<app-page-help-panel
  *ngIf="helpContent"
  [content]="helpContent"
  [isOpen]="helpPanelOpen">
</app-page-help-panel>
