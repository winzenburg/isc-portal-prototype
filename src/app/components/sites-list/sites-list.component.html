<!-- M3 Enhanced Sites List with WCAG 2.1 Compliance -->
<div class="sites-container">
  <div class="sites-header">
    <h1 class="md3-headline-large"
        [style.color]="'var(--md-sys-color-on-surface)'">
      Sites
    </h1>
    <button mat-raised-button class="md3-button-filled"
            aria-label="Add new site">
      <mat-icon>add</mat-icon>
      <span class="md3-label-large">Add Site</span>
    </button>
  </div>

  <!-- Filters and Search -->
  <mat-card class="filters-card md3-card-filled">
    <mat-card-content>
      <div class="filters-row">
        <mat-form-field class="search-field" appearance="outline">
          <mat-icon matPrefix
                    [style.color]="'var(--md-sys-color-on-surface-variant)'">
            search
          </mat-icon>
          <input matInput (keyup)="applyFilter($event)"
                 placeholder="Search sites..."
                 aria-label="Search sites by name, ID, or address"
                 class="md3-body-large">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label class="md3-body-medium">Status</mat-label>
          <mat-select aria-label="Filter by site status">
            <mat-option value="all">All</mat-option>
            <mat-option value="active">Active</mat-option>
            <mat-option value="pending">Pending</mat-option>
            <mat-option value="inactive">Inactive</mat-option>
          </mat-select>
        </mat-form-field>

        <button mat-stroked-button class="md3-button-outlined"
                aria-label="Show additional filter options">
          <mat-icon>filter_list</mat-icon>
          <span class="md3-label-large">More Filters</span>
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Bulk Actions Bar - Issue #4 Solution (M3 Enhanced) -->
  <div class="bulk-actions-bar md3-surface-info" *ngIf="selection.selected.length > 0"
       role="status"
       [attr.aria-label]="selection.selected.length + ' sites selected'">
    <div class="bulk-actions-info">
      <mat-icon [style.color]="'var(--md-sys-color-info)'">info</mat-icon>
      <span class="md3-body-medium"
            [style.color]="'var(--md-sys-color-on-info-container)'">
        {{ selection.selected.length }} site(s) selected
      </span>
    </div>
    <div class="bulk-actions-buttons">
      <button mat-stroked-button (click)="onExport()" class="md3-button-outlined"
              aria-label="Export selected sites">
        <mat-icon>download</mat-icon>
        <span class="md3-label-large">Export</span>
      </button>
      <button mat-stroked-button (click)="onBulkDelete()" class="md3-button-outlined-error"
              aria-label="Delete selected sites">
        <mat-icon>delete</mat-icon>
        <span class="md3-label-large">Delete</span>
      </button>
    </div>
  </div>

  <!-- Confirmation Dialog - Issue #5 Solution (M3 Enhanced) -->
  <mat-card class="confirmation-dialog md3-surface-warning" *ngIf="showDeleteConfirm"
            role="alertdialog"
            aria-labelledby="confirm-title"
            aria-describedby="confirm-message">
    <mat-card-content>
      <div class="confirmation-content">
        <mat-icon class="confirmation-icon"
                  [style.color]="'var(--md-sys-color-warning)'"
                  aria-hidden="true">
          warning
        </mat-icon>
        <div>
          <h3 id="confirm-title" class="md3-title-medium"
              [style.color]="'var(--md-sys-color-on-warning-container)'">
            Confirm Deletion
          </h3>
          <p id="confirm-message" class="md3-body-medium"
             [style.color]="'var(--md-sys-color-on-warning-container)'">
            Are you sure you want to delete {{ selection.selected.length }} site(s)? This action cannot be undone.
          </p>
        </div>
      </div>
      <div class="confirmation-actions">
        <button mat-button (click)="cancelDelete()" class="md3-button-text"
                aria-label="Cancel deletion">
          <span class="md3-label-large">Cancel</span>
        </button>
        <button mat-raised-button (click)="confirmDelete()" class="md3-button-filled-error"
                aria-label="Confirm deletion of selected sites">
          <mat-icon>delete</mat-icon>
          <span class="md3-label-large">Delete</span>
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Sites Table (M3 Enhanced) -->
  <mat-card class="table-card md3-card-outlined">
    <table mat-table [dataSource]="dataSource" matSort class="sites-table"
           aria-label="Sites table with sorting and bulk actions">
      <!-- Checkbox Column -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox
            (change)="$event ? masterToggle() : null"
            [checked]="selection.hasValue() && isAllSelected()"
            [indeterminate]="selection.hasValue() && !isAllSelected()"
            aria-label="Select all sites">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox
            (click)="$event.stopPropagation()"
            (change)="$event ? selection.toggle(row) : null"
            [checked]="selection.isSelected(row)"
            [attr.aria-label]="'Select ' + row.name">
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Name Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header
            class="md3-label-large">
          Site Name
        </th>
        <td mat-cell *matCellDef="let site">
          <div class="site-name">
            <strong class="md3-body-large"
                    [style.color]="'var(--md-sys-color-on-surface)'">
              {{ site.name }}
            </strong>
            <span class="site-id md3-label-small"
                  [style.color]="'var(--md-sys-color-on-surface-variant)'">
              {{ site.id }}
            </span>
          </div>
        </td>
      </ng-container>

      <!-- Address Column -->
      <ng-container matColumnDef="address">
        <th mat-header-cell *matHeaderCellDef class="md3-label-large">
          Address
        </th>
        <td mat-cell *matCellDef="let site">
          <span class="md3-body-medium"
                [style.color]="'var(--md-sys-color-on-surface-variant)'">
            {{ site.address }}
          </span>
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header
            class="md3-label-large">
          Status
        </th>
        <td mat-cell *matCellDef="let site">
          <app-status-badge
            [type]="site.status === 'active' ? 'success' : site.status === 'pending' ? 'warning' : 'error'"
            [label]="site.status | titlecase">
          </app-status-badge>
        </td>
      </ng-container>

      <!-- Circuits Column -->
      <ng-container matColumnDef="circuits">
        <th mat-header-cell *matHeaderCellDef mat-sort-header
            class="md3-label-large">
          Circuits
        </th>
        <td mat-cell *matCellDef="let site">
          <span class="md3-body-medium"
                [style.color]="'var(--md-sys-color-on-surface)'">
            {{ site.circuits }}
          </span>
        </td>
      </ng-container>

      <!-- Last Updated Column -->
      <ng-container matColumnDef="lastUpdated">
        <th mat-header-cell *matHeaderCellDef mat-sort-header
            class="md3-label-large">
          Last Updated
        </th>
        <td mat-cell *matCellDef="let site">
          <span class="md3-body-medium"
                [style.color]="'var(--md-sys-color-on-surface-variant)'">
            {{ site.lastUpdated | date:'short' }}
          </span>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="md3-label-large">
          Actions
        </th>
        <td mat-cell *matCellDef="let site">
          <button mat-icon-button [matMenuTriggerFor]="menu"
                  [attr.aria-label]="'Actions for ' + site.name">
            <mat-icon [style.color]="'var(--md-sys-color-on-surface-variant)'">
              more_vert
            </mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="viewSite(site)"
                    aria-label="View site details">
              <mat-icon>visibility</mat-icon>
              <span class="md3-label-large">View Details</span>
            </button>
            <button mat-menu-item (click)="editSite(site)"
                    aria-label="Edit site">
              <mat-icon>edit</mat-icon>
              <span class="md3-label-large">Edit</span>
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="deleteSite(site)"
                    class="destructive-menu-item"
                    aria-label="Delete site">
              <mat-icon>delete</mat-icon>
              <span class="md3-label-large">Delete</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      <!-- Empty State - Issue #2 Solution -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          <app-empty-state
            icon="location_on"
            title="No sites found"
            message="Try adjusting your search or filters to find what you're looking for."
            actionLabel="Add Site"
            actionIcon="add">
          </app-empty-state>
        </td>
      </tr>
    </table>

    <mat-paginator
      [pageSizeOptions]="[5, 10, 25, 100]"
      showFirstLastButtons>
    </mat-paginator>
  </mat-card>
</div>
